(()=>{"use strict";class e{constructor(){this.apiKey=null,this.knowledgeBase=null,this.secureStorage=null,"undefined"!=typeof SecureStorage&&(this.secureStorage=new SecureStorage)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async loadKnowledgeBase(){if(this.knowledgeBase)return this.knowledgeBase;try{const e="undefined"!=typeof chrome&&chrome.runtime?chrome.runtime.getURL("data/knowledge-base.json"):"/data/knowledge-base.json",t=await fetch(e);return this.knowledgeBase=await t.json(),this.knowledgeBase}catch(e){return console.error("Failed to load knowledge base:",e),null}}generateSystemPrompt(e){return'You MUST respond ONLY with valid JSON. No other text.\n\n{\n  "prompt": "flowing, narrative Veo 3 video prompt",\n  "core_elements": {\n    "subject": "who/what",\n    "context": "where", \n    "action": "what happens",\n    "style": "visual mood"\n  },\n  "optional_elements": {\n    "camera": "movement",\n    "dialogue": "speech",\n    "sounds": "audio"\n  }\n}\n\nWrite cinematic, flowing prompts that adapt to different contexts (ads, interviews, home videos, sketches, etc.). Be flexible and logical - don\'t copy inappropriate details from one context to another. CRITICAL: Follow user instructions exactly - implement every requested change. JSON format only.'}async setApiKey(e){if(!e)return this.secureStorage?await this.secureStorage.removeApiKey():await chrome.storage.local.remove(["gptApiKey"]),void(this.apiKey=null);try{this.secureStorage?(await this.secureStorage.storeApiKey(e),this.apiKey=e):(this.apiKey=e,await chrome.storage.local.set({gptApiKey:e}))}catch(e){throw console.error("Failed to store API key:",e),e}}async getApiKey(){if(this.apiKey)return this.apiKey;try{if(this.secureStorage)return await this.secureStorage.migrateOldKey(),this.apiKey=await this.secureStorage.getApiKey(),this.apiKey;{const e=await chrome.storage.local.get(["gptApiKey"]);return this.apiKey=e.gptApiKey||null,this.apiKey}}catch(e){return console.error("Failed to retrieve API key:",e),this.apiKey=null,null}}async modifyPrompt(e){if(!e.instruction?.trim())throw new Error("üìù Modification instruction required: Please describe how you want to modify the prompt.");const t=await this.loadKnowledgeBase(),r=this.generateSystemPrompt(t);try{let t=await fetch("https://veoprompter.netlify.app/.netlify/functions/gpt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o",systemPrompt:r,prompt:e.prompt,instruction:e.instruction,temperature:.7,maxTokens:800})});if(!t.ok){const e=await t.json().catch(()=>({})),r=e.error?.message||e.message;if(console.error("GPT API Response Error:",{status:t.status,statusText:t.statusText,errorData:e,url:t.url}),401===t.status)throw new Error("üîê Unauthorized: Backend API key invalid or missing.");if(403===t.status)throw new Error("üö´ Access denied by backend.");if(429===t.status)throw new Error("‚è∞ Rate limit exceeded. Please try again later.");if(t.status>=500)throw new Error("üîß Server error: Please try again shortly.");if(400===t.status)throw new Error(`üìù Bad request: ${r||"Invalid prompt or instruction format."}`);if(404===t.status)throw new Error("üîß Service unavailable: The AI modification service is not currently deployed. Please contact support.");throw new Error(`‚ùå Request failed (${t.status}): ${r||t.statusText||"Please try again."}`)}const o=await t.json();if(!o?.content)throw new Error("üì≠ Empty response: The AI didn't generate a response. Please try again with a different instruction.");let a;try{const e=JSON.parse(o.content);a=e.prompt?String(e.prompt).trim():String(o.content).trim()}catch(e){a=String(o.content).trim()}return a}catch(e){if(console.error("GPT API error:",e),e instanceof TypeError&&e.message.includes("fetch"))throw new Error("üåê Connection failed: Please check your internet connection and try again.");throw e}}}const t=new Map,r="undefined"!=typeof ExtPay?ExtPay("veo-3-prompter"):null;async function o(t){if(!t.instruction?.trim())throw new Error("üìù Modification instruction required: Please describe how you want to modify the prompt.");const r=e.getInstance(),o=await r.loadKnowledgeBase(),a=r.generateSystemPrompt(o);try{let e=await fetch("https://veoprompter.netlify.app/.netlify/functions/gpt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4o",systemPrompt:a,prompt:t.prompt,instruction:t.instruction,temperature:.7,maxTokens:800,userEmail:t.userEmail,isPremium:t.isPremium})});if(!e.ok){const t=await e.json().catch(()=>({})),r=t.error?.message||t.message;if(401===e.status)throw new Error("üîê Unauthorized: Backend API key invalid or missing.");if(403===e.status)throw new Error("üö´ Access denied by backend.");if(429===e.status)throw new Error(r||"‚è∞ Rate limit exceeded. Please try again later.");if(e.status>=500)throw new Error("üîß Server error: Please try again shortly.");if(400===e.status)throw new Error(`üìù Bad request: ${r||"Invalid prompt or instruction format."}`);if(404===e.status)throw new Error("üîß Service unavailable: The AI modification service is not currently deployed. Please contact support.");throw new Error(`‚ùå Request failed (${e.status}): ${r||e.statusText||"Please try again."}`)}const r=await e.json();if(!r?.content)throw new Error("üì≠ Empty response: The AI didn't generate a response. Please try again with a different instruction.");try{const e=JSON.parse(r.content);if(e.prompt)return String(e.prompt).trim()}catch(e){}return String(r.content).trim()}catch(e){if(console.error("GPT API error:",e),e instanceof TypeError&&e.message.includes("fetch"))throw new Error("üåê Connection failed: Please check your internet connection and try again.");throw e}}chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.sidePanel.open({tabId:e.id})}),chrome.tabs.onUpdated.addListener(async(e,r,o)=>{if(r.url&&t.has(e)){const o=r.url;if(o.includes("veoprompter.netlify.app/oauth-redirect")){const r=t.get(e);t.delete(e);try{await chrome.tabs.remove(e);const t=new URL(o).searchParams.get("code");if(console.log("OAuth redirect detected:",o),console.log("Authorization code:",t?"received":"missing"),!t)throw new Error("No authorization code received");const a="https://veoprompter.netlify.app/oauth-redirect",s=await fetch("https://veoprompter.netlify.app/.netlify/functions/gpt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oauth:"exchange",code:t,redirectUri:a})});if(console.log("Exchange response status:",s.status),!s.ok){let e="Failed to exchange code for token";try{const t=await s.text();console.error("OAuth exchange error response:",t);try{const r=JSON.parse(t);e=r.error||r.details||t}catch{e=t}}catch(e){console.error("Failed to read error response:",e)}throw new Error(e)}const n=await s.json();if(console.log("OAuth exchange success:",n),!n.success)throw console.error("OAuth data indicates failure:",n),new Error(n.error||n.details||"OAuth exchange failed");await chrome.storage.local.set({user:{email:n.user.email,name:n.user.name,picture:n.user.picture,id:n.user.id},authToken:{access_token:n.token.access_token,refresh_token:n.token.refresh_token,expires_at:n.token.expires_at}}),r({success:!0,user:{email:n.user.email,name:n.user.name,picture:n.user.picture}})}catch(e){console.error("OAuth flow error:",e),r({success:!1,error:e instanceof Error?e.message:String(e)})}}}}),chrome.tabs.onRemoved.addListener(e=>{if(t.has(e)){const r=t.get(e);t.delete(e),r({success:!1,error:"Sign in cancelled"})}}),chrome.runtime.onInstalled.addListener(()=>{chrome.storage.local.set({userLibrary:{savedPrompts:[],customTags:{},lastUpdated:(new Date).toISOString()}}),r&&(r.startBackground(),r.onPaid.addListener(e=>{console.log("User paid via ExtPay:",e),chrome.runtime.sendMessage({type:"PAYMENT_STATUS_CHANGED",user:e})})),console.log("Extension installed and ExtPay background service started")}),chrome.runtime.onMessage.addListener((e,a,s)=>"GET_USER_LIBRARY"===e.type?(chrome.storage.local.get(["userLibrary"],e=>{s(e.userLibrary)}),!0):"GET_PAYMENT_STATUS"===e.type?(r?r.getUser().then(e=>{s({paid:e.paid||!1,paidAt:e.paidAt?new Date(e.paidAt):void 0,installedAt:new Date(e.installedAt),trialStartedAt:e.trialStartedAt?new Date(e.trialStartedAt):void 0,email:e.email,subscriptionStatus:e.subscriptionStatus})}).catch(e=>{console.error("Error getting payment status:",e),s({paid:!1,installedAt:new Date})}):s({paid:!1,installedAt:new Date}),!0):"UPDATE_USER_LIBRARY"===e.type?(chrome.storage.local.set({userLibrary:e.data},()=>{s({success:!0})}),!0):"GOOGLE_SIGN_IN"===e.type?((async()=>{try{const e=`https://accounts.google.com/o/oauth2/v2/auth?client_id=374428444834-b7m6bvo4uv5bo4gkib44g858g6cl2feb.apps.googleusercontent.com&redirect_uri=${encodeURIComponent("https://veoprompter.netlify.app/oauth-redirect")}&response_type=code&scope=${encodeURIComponent("https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile")}&state=${Date.now()}`,r=await chrome.tabs.create({url:e,active:!0});t.set(r.id,s)}catch(e){s({success:!1,error:e instanceof Error?e.message:"OAuth setup failed"})}})(),!0):"GOOGLE_SIGN_OUT"===e.type?(chrome.storage.local.remove(["user","authToken"],()=>{s({success:!0})}),!0):"IMPROVE_PROMPT"===e.type?((async()=>{try{const t=await chrome.storage.local.get(["user","dailyUsage"]),a=t.user;if(!a||!a.email)return void s({success:!1,error:"üîê Please sign in to use AI features. Click the extension icon to sign in with Google."});const n=(new Date).toISOString().split("T")[0];let i=t.dailyUsage||{date:n,count:0};i.date!==n&&(i.date=n,i.count=0);const c=!!r&&(await r.getUser()).paid,l=await o({prompt:e.prompt,instruction:"Improve this prompt by enhancing its cinematic flow and narrative quality. Add vivid details that create atmosphere and smooth action transitions. Maintain the original concept while making it more evocative and story-driven for Veo 3.",userEmail:a.email,isPremium:c});c||(i.count++,await chrome.storage.local.set({dailyUsage:i}),chrome.runtime.sendMessage({type:"USAGE_UPDATED",dailyUsage:i}).catch(()=>{})),s({success:!0,improvedPrompt:l})}catch(e){s({success:!1,error:e instanceof Error?e.message:"Failed to improve prompt"})}})(),!0):"CHANGE_PROMPT"===e.type&&((async()=>{try{const t=await chrome.storage.local.get(["user","dailyUsage"]),a=t.user;if(!a||!a.email)return void s({success:!1,error:"üîê Please sign in to use AI features. Click the extension icon to sign in with Google."});const n=(new Date).toISOString().split("T")[0];let i=t.dailyUsage||{date:n,count:0};i.date!==n&&(i.date=n,i.count=0);const c=!!r&&(await r.getUser()).paid,l=await o({prompt:e.prompt,instruction:`CHANGE REQUEST: "${e.instructions}". Adapt the core concept to this new context. Don't copy inappropriate details - understand the essence and recreate it appropriately. Make the change realistic and logical for the new subject matter.`,userEmail:a.email,isPremium:c});c||(i.count++,await chrome.storage.local.set({dailyUsage:i}),chrome.runtime.sendMessage({type:"USAGE_UPDATED",dailyUsage:i}).catch(()=>{})),s({success:!0,changedPrompt:l})}catch(e){s({success:!1,error:e instanceof Error?e.message:"Failed to change prompt"})}})(),!0))})();