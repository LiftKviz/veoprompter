<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Firebase Debug</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    .section { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .log { padding: 8px; margin: 5px 0; border-left: 3px solid #ddd; }
    .error { background: #ffebee; border-color: #f44336; color: #c62828; }
    .success { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
    .info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    pre { background: #263238; color: #aed581; padding: 10px; border-radius: 5px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Advanced Firebase Authentication Debug</h1>
  
  <div class="section">
    <h3>Environment Information</h3>
    <div id="env-info"></div>
  </div>
  
  <div class="section">
    <h3>Test Controls</h3>
    <button onclick="initFirebase()">1. Initialize Firebase</button>
    <button onclick="checkAuthState()">2. Check Auth State</button>
    <button onclick="testGooglePopup()">3. Test Google Popup</button>
    <button onclick="testGoogleRedirect()">4. Test Google Redirect</button>
    <button onclick="testEmailAuth()">5. Test Email Auth</button>
    <button onclick="checkNetwork()">6. Check Network</button>
    <button onclick="clearAll()">Clear Logs</button>
  </div>
  
  <div class="section">
    <h3>Logs</h3>
    <div id="logs"></div>
  </div>
  
  <div class="section">
    <h3>Configuration</h3>
    <pre id="config"></pre>
  </div>

  <!-- Updated Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <script>
    const logs = document.getElementById('logs');
    const envInfo = document.getElementById('env-info');
    const configPre = document.getElementById('config');
    
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCDsAJx-JUCuKC1-YR16N7APYpTh--SSLo",
      authDomain: "videoprompter-d6a18.firebaseapp.com",
      projectId: "videoprompter-d6a18",
      storageBucket: "videoprompter-d6a18.firebasestorage.app",
      messagingSenderId: "43646976330",
      appId: "1:43646976330:web:6d57b38a3f6c98d4c2c1b3"
    };
    
    // Display config
    configPre.textContent = JSON.stringify(firebaseConfig, null, 2);
    
    // Display environment info
    envInfo.innerHTML = `
      <div class="log info">
        <strong>Domain:</strong> ${window.location.hostname}<br>
        <strong>Protocol:</strong> ${window.location.protocol}<br>
        <strong>User Agent:</strong> ${navigator.userAgent}<br>
        <strong>Cookies Enabled:</strong> ${navigator.cookieEnabled}<br>
        <strong>Local Storage:</strong> ${typeof(Storage) !== "undefined" ? 'Available' : 'Not Available'}<br>
        <strong>Third Party Cookies:</strong> <span id="third-party-check">Checking...</span>
      </div>
    `;
    
    // Check third-party cookies
    checkThirdPartyCookies();
    
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `<strong>${time}</strong>: ${message}`;
      logs.insertBefore(div, logs.firstChild);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function checkThirdPartyCookies() {
      // Try to set a cookie on Firebase domain
      const img = new Image();
      img.src = 'https://videoprompter-d6a18.firebaseapp.com/favicon.ico';
      img.onload = () => {
        document.getElementById('third-party-check').textContent = 'Likely Enabled';
      };
      img.onerror = () => {
        document.getElementById('third-party-check').textContent = 'Possibly Blocked';
      };
    }
    
    let app = null;
    let auth = null;
    
    function initFirebase() {
      try {
        if (!app) {
          app = firebase.initializeApp(firebaseConfig);
          auth = firebase.auth();
          log('Firebase initialized successfully', 'success');
          
          // Set up auth state listener
          auth.onAuthStateChanged((user) => {
            if (user) {
              log(`Auth state: Signed in as ${user.email} (${user.uid})`, 'success');
            } else {
              log('Auth state: Not signed in', 'info');
            }
          });
          
          // Check for redirect result
          auth.getRedirectResult()
            .then((result) => {
              if (result.user) {
                log(`Redirect sign-in completed: ${result.user.email}`, 'success');
              }
            })
            .catch((error) => {
              if (error.code !== 'auth/no-auth-event') {
                log(`Redirect error: ${error.code} - ${error.message}`, 'error');
              }
            });
            
        } else {
          log('Firebase already initialized', 'info');
        }
      } catch (error) {
        log(`Firebase init error: ${error.message}`, 'error');
      }
    }
    
    function checkAuthState() {
      if (!auth) {
        log('Firebase not initialized. Click "Initialize Firebase" first.', 'error');
        return;
      }
      
      const user = auth.currentUser;
      if (user) {
        log(`Current user: ${user.email} (${user.uid})`, 'success');
        log(`Provider: ${user.providerData[0]?.providerId || 'Unknown'}`, 'info');
      } else {
        log('No user currently signed in', 'info');
      }
    }
    
    async function testGooglePopup() {
      if (!auth) {
        log('Firebase not initialized. Click "Initialize Firebase" first.', 'error');
        return;
      }
      
      log('Testing Google popup sign-in...', 'info');
      const provider = new firebase.auth.GoogleAuthProvider();
      
      try {
        const result = await auth.signInWithPopup(provider);
        log(`Popup sign-in successful: ${result.user.email}`, 'success');
        
        // Sign out after 3 seconds
        setTimeout(() => {
          auth.signOut();
          log('Signed out', 'info');
        }, 3000);
      } catch (error) {
        log(`Popup error: ${error.code}`, 'error');
        log(`Message: ${error.message}`, 'error');
        
        if (error.code === 'auth/popup-blocked') {
          log('Solution: Enable popups for this site in your browser', 'info');
        } else if (error.code === 'auth/unauthorized-domain') {
          log('Solution: Add this domain to Firebase authorized domains', 'info');
        } else if (error.code === 'auth/popup-closed-by-user') {
          log('User closed the popup', 'info');
        }
      }
    }
    
    async function testGoogleRedirect() {
      if (!auth) {
        log('Firebase not initialized. Click "Initialize Firebase" first.', 'error');
        return;
      }
      
      log('Testing Google redirect sign-in...', 'info');
      log('You will be redirected to Google. Check logs when you return.', 'info');
      const provider = new firebase.auth.GoogleAuthProvider();
      
      try {
        await auth.signInWithRedirect(provider);
      } catch (error) {
        log(`Redirect initiation error: ${error.code} - ${error.message}`, 'error');
      }
    }
    
    async function testEmailAuth() {
      if (!auth) {
        log('Firebase not initialized. Click "Initialize Firebase" first.', 'error');
        return;
      }
      
      const email = prompt('Enter test email:');
      const password = prompt('Enter test password:');
      
      if (!email || !password) {
        log('Email/password not provided', 'error');
        return;
      }
      
      try {
        // Try to create user first
        log('Attempting to create user...', 'info');
        const result = await auth.createUserWithEmailAndPassword(email, password);
        log(`User created: ${result.user.email}`, 'success');
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          // Try to sign in
          try {
            log('User exists, attempting sign in...', 'info');
            const result = await auth.signInWithEmailAndPassword(email, password);
            log(`Sign in successful: ${result.user.email}`, 'success');
          } catch (signInError) {
            log(`Sign in error: ${signInError.code} - ${signInError.message}`, 'error');
          }
        } else {
          log(`Create user error: ${error.code} - ${error.message}`, 'error');
        }
      }
    }
    
    async function checkNetwork() {
      log('Checking network connectivity...', 'info');
      
      // Check Firebase
      try {
        const response = await fetch('https://videoprompter-d6a18.firebaseapp.com/');
        log(`Firebase domain accessible: ${response.ok ? 'Yes' : 'No (Status: ' + response.status + ')'}`, response.ok ? 'success' : 'error');
      } catch (error) {
        log('Firebase domain not accessible: ' + error.message, 'error');
      }
      
      // Check Google
      try {
        const response = await fetch('https://accounts.google.com/favicon.ico');
        log(`Google accessible: ${response.ok ? 'Yes' : 'No'}`, response.ok ? 'success' : 'error');
      } catch (error) {
        log('Google not accessible: ' + error.message, 'error');
      }
      
      // Check current domain
      log(`Current domain HTTPS: ${window.location.protocol === 'https:' ? 'Yes' : 'No'}`, 
          window.location.protocol === 'https:' ? 'success' : 'error');
    }
    
    function clearAll() {
      logs.innerHTML = '';
      log('Logs cleared', 'info');
    }
    
    // Auto-initialize on load
    window.addEventListener('load', () => {
      log('Page loaded. Click "Initialize Firebase" to start.', 'info');
    });
  </script>
</body>
</html>